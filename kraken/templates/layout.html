<!DOCTYPE html>
<html>
	  <head>
		    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
		    <meta name="uuid" content="{{ uuid }}"/>
		    <meta itemprop="text_direction" content="{{ text_direction }}"/>
        <link rel="stylesheet" type="text/css" href="css/style.css" />
		    <style>
			   {% include 'style.css' %}
		    </style>
	  </head>
	  <body>
        <script src="https://code.jquery.com/jquery-1.12.4.min.js"
			          integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ="
			          crossorigin="anonymous">
        </script>

		    <script>
			   $(document).ready(function() {
				     var uuid = $('meta[name=uuid]').attr('content');
				     if (localStorage) {
					       $('li[contenteditable=true], span').each(function(index) {
						         if(localStorage[uuid + this.id]) {
							           $(this).text(localStorage[uuid + this.id]);
						         }
					       });
				     }
				     // focus text fields when lines/words are clicked + mouseover
				     $('a.rect').click(function(e) {
					       e.preventDefault();
					       $('#' + $(this).attr('alt')).focus();
				     }).mouseover(function(e) {
					       $('#' + $(this).attr('alt')).addClass("hovered");
				     }).mouseout(function(e) {
					       $('#' + $(this).attr('alt')).removeClass("hovered");
				     });
				     // create mouseover effect on text fields
				     $('li[contenteditable=true], span').mouseover(function(e) {
					       console.log(this.id);
					       $('a.rect[alt=' + this.id + ']').addClass("hovered");
				     }).mouseout(function(e) {
					       $('a.rect[alt=' + this.id + ']').removeClass("hovered");
				     }).focusin(function(e) {
					       $('a.rect[alt=' + this.id + ']').addClass("hovered");
				     }).focusout(function(e) {
					       $('a.rect[alt=' + this.id + ']').removeClass("hovered");
				     }).keydown(function(e) {
					       if(e.which == 13) {
						         e.preventDefault();
						         $(this).addClass('corrected');
						         var $els = $('[contenteditable=true]');
						         $els.eq($els.index(this) + 1).focus();
					       }
				         // save to local storage 
				     }).keyup(function () {
					       localStorage[uuid + this.id] = $(this).text();
				     });
				     
				     // smooth scrolling
				     $('.page_anchor').click(function(e) {
					       e.preventDefault();
					       var target = $(this).attr("href");
					       var top = $(target).offset().top;
					       $('html, body').stop().animate({scrollTop: top }, 500);
				     });

				     // serializing the DOM to a file
				     $('#download_button').click(function(e) {
					       path = window.location.pathname;
					       $(this).attr('href', 'data:text/html,' + encodeURIComponent($('html')[0].outerHTML));
					       $(this).attr('download', path.substr(path.lastIndexOf('/') + 1));
				     });
			   });
		    </script>
		    <nav>
			      <ul>
			          {% for page in pages %}
				        <li><a class="page_anchor" href='#page_{{ page.index }}'>{{ page.index }}</a></li>
			          {% endfor %}
			      </ul>
			      <a id="download_button" href="#">Download</a>
		    </nav>

		    {% for page in pages %}
		    <section class="page container" id="page-{{ page.index }}">
			      <div class="column">
				        <div class="img-container" id="page-image-div">
					          <img style="width: 100%;"
                         src="images/page_{{ page.index }}.{{ page.img_format }}"
                         alt="photo"
                         id="image-page"/>
                    <canvas style="width: 100%" id="image-canvas"></canvas>
                    <script>var lines = [];</script>
					          {% for line in page.lines %}
					          <a class="rect" alt="line_{{ line.index }}" href="" title="" style="left: {{ line.left }}%; top: {{ line.top }}%; width: {{ line.width }}%; height: {{ line.height }}%; z-index: 2;" id="{{ line.index }}"></a>
                    <!-- This is the bounding boxes overlayed on the image -->
                    <script>
                     var line = {
                         "x1" : "{{ line.left_real }}",
                         "width" : "{{ line.width_real }}",
                         "y1" : "{{ line.top_real }}",
                         "height" : "{{ line.height_real }}",
                         "index" : "{{ line.index }}",
                         "bbox" : "{{ line.bbox  }}"
                     };
                     lines.push(line);
                    </script>
					          {% endfor %}
				        </div>
			      </div>
			      <div class="column">
                <fieldset>
                    <button onclick="deleteBoxes()" id="deleteButton">
                        Delete Marked Lines
                    </button>
                    <button onclick="undoDeletion()" id="undodeleteButton">
                        Undo Deletion
                    </button>
                    <button onclick="sortLines()" id="sortButton">
                        Sort Lines
                    </button>
                    <button onclick="resetRect()" id="resetRectButton">
                        Reset Selection
                        </button>
                        <button onclick="addTranscription()" id="addTranscriptionButton">
                            Add Transcription
                        </button>
                </fieldset>
				        <ol id="text-line-list">
                    <!-- Contains the lines -->
				            {% for line in page.lines %}
                    <li class="item-group" id="ig{{ line.index }}">
                        <ul class="item-list" id="il{{ line.index }}">
                            <li>
					                      <textarea id="el{{ line.index }}"
                                          spellcheck="true"
                                          rows="2"
                                          cols="100"
                                          data-bbox="{{ line.bbox }}"
                                          placeholder="Enter text for line {{ line.index }}"
                                          class="editable-textarea">
                                    <!-- This is the texts of the line on the image -->
						                    {% if line.text %}
							                  {{ line.text }}
						                    {% endif %}
                                </textarea>
                            </li>
                            <li class="line-widget" id="lw{{ line.index }}">
                                <label class="cbox-container">
                                    Mark for deletion
                                    <input type="checkbox"
                                           id="lcbox{{ line.index }}"
                                           class="line-cbox">
                                    <span class="checkmark"></span>
                                </label>
					                  </li>
                        </ul>
                    </li>
				            {% endfor %}
                </ol>
			      </div>
		    </section>
		    {% endfor %}

	  </body>
</html>
